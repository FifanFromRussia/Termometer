MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;__________________________________________________________________________________________________
                      00002 ;|-------------------------------------------------------------------------------------------------|
                      00003 ;| УСТРОЙСТВО: термометр с динамической индикацией                                                 |
                      00004 ;|-------------------------------------------------------------------------------------------------|
                      00005 ;| АВТОР:      picmaniac (picmaniac@rambler.ru)  FREEWARE                                               
                                                       |
                      00006 ;| ОТРЕДАКТИРОВАЛ:              Deman           (bzzzsmuv@rambler.ru)           ВЕРСИЯ: 2.4b   ДАТА: 21.
                             11. 2007 г.       |
                      00007 ;| ОТРЕДАКТИРОВАЛ под свои сегменты: Fifan (retrohobby@yandex.ru) ДАТА: 04.03.2015 г.                   
                               |
                      00008 ;|-------------------------------------------------------------------------------------------------|
                      00009 ;|-------------------------------------------------------------------------------------------------|
                      00010 ;| Работа устройства:                                                                                   
                               |
                      00011 ;|              Добавлен SLEEP для работы от батареек с прерыванием по фронту на RB0 (6 вывод)          
                               |
                      00012 ;|-------------------------------------------------------------------------------------------------|
                      00013 ;| Замечания по аппаратной части: версия для PIC16F628A, годится и для PIC16F628                   |
                      00014 ;|-------------------------------------------------------------------------------------------------|
                      00015 ;| Замечания по программе: создана в среде MPLAB 7.42 под WINDOWS XP SP1                           |
                      00016 ;|_________________________________________________________________________________________________|
                      00017 
                      00018                  LIST P=16F628A  
                      00019                  #include <P16F628A.inc>        ;Добавляем стандартный файл заголовка MPLAB
                      00001         LIST
                      00002 ; P16F628A.INC  Standard Header File, Version 1.10    Microchip Technology, Inc.
                      00265         LIST
                      00266 
2007   3F10           00020  __CONFIG 3F10
                      00021                                  radix    hex
                      00022 
                      00023                 #define         BUT             PORTA,0
                      00024                 #define         ds4             PORTA,4
                      00025                 #define         SLS             PORTA,5
                      00026                 #define         ds7             PORTA,7
                      00027 
                      00028                 #define autsam  flag,0          
                      00029                 #define V4_7    flag,1          
                      00030 ;                          --- Константы  ---
                      00031 
                      00032 ;                         --- Макрокоманды ---
                      00033 
                      00034 jnz             MACRO           metka1                                          ; условный переход,
                      00035                 btfss           STATUS,Z                                        ; если не 0
                      00036                 goto            metka1
                      00037                 endm
                      00038 
                      00039 jz              MACRO           metka2                                          ; условный переход,
                      00040                 btfsc           STATUS,Z                                        ; если 0
                      00041                 goto            metka2
                      00042                 endm
                      00043 
                      00044 jnc             MACRO           metka3                                          ; условный переход,
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00045                 btfss           STATUS,C                                        ; если нет переноса
                      00046                 goto            metka3
                      00047                 endm
                      00048 
                      00049 jc              MACRO           metka4                                          ; условный переход,
                      00050                 btfsc           STATUS,C                                        ; если перенос
                      00051                 goto            metka4
                      00052                 endm
                      00053 
                      00054 mov     MACRO   DEST1,SOURCE1                                   ; пересылка регистр-регистр
                      00055                 movf    SOURCE1,W
                      00056                 movwf   DEST1
                      00057                 endm
                      00058 
                      00059 mvi     MACRO   DEST2,CONST2                                    ; пересылка константы в регистр
                      00060                 movlw   CONST2
                      00061                 movwf   DEST2
                      00062                 endm
                      00063 
                      00064 ;                         --- ОПИСАНИЕ РЕГИСТРОВ ---
  00000020            00065 W_copy                          EQU             020h                                            ; В этих
                             регистрах будет 
  00000021            00066 ST_copy                         EQU             021h                                            ; сохран
                            яться контекст
  00000022            00067 FSR_copy        EQU             022h
  00000023            00068 ADDRESS                         EQU             023h                                            ; Хранен
                            ие адреса ячейки, задающей состояние светодиодов
  00000024            00069 SELECTOR        EQU             024h                                            ; Код выбора знакоместа 
                            (т.е зажигаемого разряда)
  00000025            00070 TH                              EQU             025h                                            ; Темпер
                            атура - старший байт
  00000026            00071 TL                              EQU             026h                                            ; Темпер
                            атура - младший байт
  00000027            00072 CRCPIC                          EQU             027h                                            ; Контро
                            льная сумма, подсчитанная микроконтроллером
  00000028            00073 TRY                             EQU             028h                                            ; Попытк
                            и чтения по 1-Wire
  00000029            00074 COUNTER                         EQU             029h                                            ; Счетчи
                            к (используется при передаче данных по 1-Wire)
  0000002A            00075 FIGX000                         EQU             02Ah                                            ; Ячейки
                             для хранения 
  0000002B            00076 FIG0X00                         EQU             02Bh                                            ; разряд
                            ов
  0000002C            00077 FIG00X0                         EQU             02Ch                                            ; двоичн
                            о-десятичных цифр,
  0000002D            00078 FIG000X                         EQU             02Dh                                            ; выводи
                            мых на индикатор
  0000002E            00079 OUTA                            EQU             02Eh                                            ; Хранен
                            ие состояний защелок порта
  0000003C            00080 TEMP1           EQU             03Ch                            ;Ячейки для врЕменного
  0000003D            00081 TEMP2           EQU     03Dh                    ; хранения данных
  0000003F            00082 FLAGS                           EQU     03Fh                                    ;Флаги пользователя
  00000040            00083 TO_1                            EQU             040h                                            ;\
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000041            00084 TO_2                            EQU             041h                                            ; \тайме
                            р
  00000042            00085 TO_3                            EQU             042h
  00000043            00086 DS4_7                           EQU             043h
  00000044            00087 AT1                             EQU             044h
  00000045            00088 AT2                             EQU             045h
                      00089 
  00000028            00090 AT_1                            equ             .40                                             ;сек - К
                            онстанта Задержки на переход в SLEEP
  00000000            00091 But                             equ             0                                               ;FLAGS,0
                            , кнопка нажата или нет
                      00092 
                      00093 ;                                                               --- ПУСК ---
0000                  00094                                 ORG 0                                                           ;Вектор 
                            сброса
                      00095 
0000   1283           00096 Reset                           bcf             STATUS,RP0                      ;Обращение к банку 0
0001   1303           00097                                 bcf             STATUS,RP1
0002   291F           00098                                 goto    Start                                   ;Обходим обработчик прер
                            ываний и подпрограммы
                      00099 ;--------------------------------------------------------------------------------------------------
                      00100 ;                                               --- ОБРАБОТЧИК ПРЕРЫВАНИЙ ---
                      00101 ;--------------------------------------------------------------------------------------------------
0004                  00102                                 ORG 4                                                           ;Вектор 
                            прерываний
                      00103 
0004   00A0           00104 Interrupt       movwf           W_copy                                          ;Сохраняем контекст
                      00105                                 mov             ST_copy,STATUS
0005   0803               M                 movf    STATUS,W
0006   00A1               M                 movwf   ST_copy
                      00106                                 mov             FSR_copy,FSR
0007   0804               M                 movf    FSR,W
0008   00A2               M                 movwf   FSR_copy
0009   2027           00107                                 call            BUTON
000A   30B0           00108                                 movlw           B'10110000'                     ;Маска для сохранения со
                            стояния бита 4 и 7 ****
000B   0585           00109                                 andwf           PORTA,F                                         ;устон. 
                            биты, управляющие светодиодами (iorwf PORTA,F ;побитное “ИЛИ”)(PORTA)
                      00110                                                                                                 ;Гасим
000C   0823           00111                                 movf            ADDRESS,W                       ;Адрес ячейки с требуемы
                            ми на данном шаге данными
000D   0084           00112                                 movwf           FSR                                             ;заносим
                             в FSR (косвенная адресация)
000E   0800           00113                                 movf            INDF,W                                          ;Перенос
                            им данные из ячейки с указанным адресом в W
000F   0086           00114                                 movwf           PORTB                                           ;И выдае
                            м через PORTB на сегменты индикатора
0010   0824           00115                                 movf            SELECTOR,W                      ;Зажигаем текущий
0011   0485           00116                                 iorwf           PORTA,F                                         ;разряд 
                            индикатора (andwf PORTA,F ;побитное “И” )
0012   1003           00117                                 bcf             STATUS,C                        ;****
0013   0CA4           00118                                 rrf             SELECTOR,F
                      00119                                                                                                 ;Далее в
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            етвление, посчитаем шаги и уравняем пути (a,b)
0014   1C03           00120                                 btfss           STATUS,C                        ;Цифра была последней в 
                            этом цикле, пропускаем переход (1)****
0015   281B           00121                                 goto            Int_label                       ;Цифра еще не последняя,
                             переход (2a) / nop(1b)
0016   302A           00122                                 movlw           FIGX000                                         ;Снова з
                            аносим адрес ячейки (1b)
0017   00A3           00123                                 movwf           ADDRESS                                         ;в ячейк
                            у ADDRESS - начался следующий цикл (1b)
0018   3008           00124                                 movlw           B'00001000'                     ;Снова готовимся к **** 
                                (1b)
0019   00A4           00125                                 movwf           SELECTOR                        ;выводу начальной цифры 
                            (1b)
001A   281F           00126                                 goto            End_int                                         ;(2b)  П
                            уть по b: 1b+1b+1b+1b+1b+2b = 7 шагов
                      00127 
001B   0AA3           00128 Int_label       incf            ADDRESS,F                       ;В следующем прерывании будем выводить с
                            ледующий байт (1a)
001C   0000           00129                                 nop
001D   0000           00130                                 nop
001E   281F           00131                                 goto            End_int                          ;(2a)  Путь по а: 2a+1a
                            +1a+1a+2a = 7 шагов
                      00132 
001F   110B           00133 End_int                         bcf             INTCON,T0IF                     ;Сбрасываем флаг запроса
                             на прерывание от таймера TMR0
                      00134                                 mov             FSR,FSR_copy
0020   0822               M                 movf    FSR_copy,W
0021   0084               M                 movwf   FSR
                      00135                                 mov             STATUS,ST_copy                  ;Восстанавливаем контекс
                            т
0022   0821               M                 movf    ST_copy,W
0023   0083               M                 movwf   STATUS
0024   0EA0           00136                                 swapf           W_copy,F                        ;Тут приходится хитрить,
                             чтобы сохранить бит Z в STATUS
0025   0E20           00137                                 swapf           W_copy,W                        ;(movf его может изменит
                            ь, а swapf - нет)
0026   0009           00138                                 retfie                                                          ;Возврат
                             из обработчика с установкой бита GIE
                      00139 
                      00140 ;--------------------------------------------------------------------------------------------------
                      00141 ;                          --- ПОДПРОГРАММЫ ---
                      00142 ;--------------------------------------------------------------------------------------------------
                      00143                 ;Подпрограмма проверки кнопки PORTB,0
0027                  00144 BUTON                           
0027   1005           00145                                 bcf             BUT
0028   1683           00146                                 bsf             STATUS,RP0                      ;Обращение к банку 1
0029   1405           00147                                 bsf             TRISA,0                                         ;Порт на
                             Вход
002A   1283           00148                                 bcf             STATUS,RP0                      ;Обращение к банку 0
002B   1C05           00149                                 btfss           BUT
002C   103F           00150                                 bcf             FLAGS,But
002D   1805           00151                                 btfsc           BUT
002E   143F           00152                                 bsf             FLAGS,But
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

002F   1683           00153                                 bsf             STATUS,RP0                      ;Обращение к банку 1
0030   1005           00154                                 bcf             TRISA,0                                         ;Порт на
                             Выход
0031   1283           00155                                 bcf             STATUS,RP0                      ;Обращение к банку 0
0032   0008           00156                 return 
                      00157 ;--------------------------------------------------------------------------------------------------
                      00158                                 ;Подпрограмма дешифрации для 7-сегм. индикатора****
                      00159 
0033   0064           00160 DC7                              clrwdt
0034   018A           00161                                 clrf            PCLATH
0035   0782           00162                                 addwf           PCL,F                                           ;Табличн
                            ая конвертация
                      00163 
                      00164 ;                         .FADEGBC
0036   3484           00165                                 retlw           B'10000100'                     ; 0  ;.FADEGBC порядок с
                            оотв. сегмент-бит
0037   34FC           00166                                 retlw           B'11111100'                     ; 1
0038   34C1           00167                                 retlw           B'11000001'                     ; 2
0039   34C8           00168                                 retlw   B'11001000'                             ; 3
003A   34B8           00169                                 retlw   B'10111000'                             ; 4
003B   348A           00170                                 retlw           B'10001010'                     ; 5
003C   3482           00171                                 retlw           B'10000010'                     ; 6
003D   34DC           00172                                 retlw           B'11011100'                     ; 7
003E   3480           00173                                 retlw           B'10000000'                     ; 8
003F   3488           00174                                 retlw   B'10001000'                             ; 9
0040   347F           00175                                 retlw           B'01111111'                     ; точка
                      00176 
                      00177                                                                                                 ;Конец п
                            одпрограммы дешифрации для 7-сегм. индикатора
                      00178 ;--------------------------------------------------------------------------------------------------
                      00179                 ;Подпрограмма паузы (используется ячейка TEMP1)
                      00180 
0041   0064           00181 Pause            clrwdt
0042   00BC           00182                                  movwf          TEMP1                           ;Длительность паузы зада
                            ется числом в W (примерно в мс)
0043   08BC           00183                                  movf   TEMP1,F                 ;Проверка на 0
0044   1903           00184                                  btfsc  STATUS,Z                ;Если длительность не равна 0, то Z=0 и 
                            пропускаем return
0045   0008           00185                                  return                         ;Если же длительность равна 0, то сразу 
                            возврат
                      00186 
0046   0103           00187                                  clrw                           ;Очищаем W
0047   3E01           00188 P_label          addlw          01h                             ;Внутренний цикл по W
                      00189                                  jnz    P_label
0048   1D03               M                 btfss           STATUS,Z                                        ; если не 0
0049   2847               M                 goto            P_label
004A   0BBC           00190                  decfsz TEMP1,F                 ;Внешний цикл по TEMP1
004B   2847           00191                  goto   P_label
                      00192 
004C   0064           00193                                  clrwdt  
004D   0008           00194                                  return                         ;Конец подпрограммы паузы
                      00195 ;--------------------------------------------------------------------------------------------------
                      00196                                 ;Подпрограмма проверки подключения DS18B20 (Используется ячейка TEMP1)
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00197 
004E   3038           00198 TestDS                           movlw          038h                                            ;
                      00199 ;////////////////
004F   1843           00200                                 btfsc           DS4_7,0                                         ;флаг вы
                            бора датчика =0 то ds4
0050   2854           00201                                 goto            DS7_0
                      00202 
0051   1E05           00203                                 btfss           ds4                             ;Термометр в состоянии о
                            жидания?
0052   2872           00204                                 goto    Test4_label                             ;Нет, активен - переход,
                             выходим
0053   2857           00205                                 goto            sbros
0054                  00206 DS7_0
0054   1F85           00207                                 btfss           ds7                             ;Термометр в состоянии о
                            жидания?
0055   2872           00208                                 goto            Test4_label                     ;Нет, активен - переход,
                             выходим                                
0056   1385           00209                                 bcf     ds7                     ;Сброс 1-Wire
0057   1205           00210 sbros                           bcf     ds4                     ;Импульс сброса (не менее 480 мкс)
0058   3050           00211                                 movlw           050h
0059   3E01           00212 Test1_label     addlw   01h
005A   1D03           00213                 btfss           STATUS,Z                        ;(за время этой паузы 3 раза происходит
005B   2859           00214                 goto    Test1_label             ; прерывание от TMR0)
                      00215 
005C   1605           00216                                 bsf             ds4
005D   1785           00217                                 bsf     ds7                     ;Сброс 1-Wire выполнен
005E   30EF           00218                                 movlw   D'239'
005F   3E01           00219 Test2_label     addlw   01h                     ;Ждем ответа от DS18B20 (пауза ~70 мкс)
0060   1D03           00220                 btfss   STATUS,Z
0061   285F           00221                 goto    Test2_label
                      00222 
0062   01BC           00223                                 clrf    TEMP1
0063   30FC           00224                                 movlw   D'252'
                      00225 ;///////////////
0064                  00226 Test3_label      
0064   1843           00227                                 btfsc           DS4_7,0                                         ;флаг вы
                            бора датчика =0 то ds4
0065   286C           00228                                 goto            DS7_1
0066   1E05           00229                                 btfss   ds4                     ;Есть отклик (0) ?
0067   0ABC           00230                                 incf    TEMP1,F                                 ;Да - инкремент TEMP1
0068   3E01           00231                                 addlw   01h
0069   1D03           00232                 btfss   STATUS,Z
006A   2864           00233                 goto    Test3_label
                      00234 
006B   2876           00235                                 goto            Testend_label                   ;конец Test3_label для D
                            S4
006C                  00236 DS7_1
006C   1F85           00237                                 btfss   ds7                     ;Есть отклик (0) ?
006D   0ABC           00238                                 incf    TEMP1,F                                 ;Да - инкремент TEMP1
006E   3E01           00239                                 addlw   01h
006F   1D03           00240                 btfss   STATUS,Z
0070   2864           00241                 goto    Test3_label
                      00242 
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0071   2876           00243                                 goto    Testend_label           ;конец Test3_label для DS7
                      00244 ;\\\\\\\\\\\\\\
0072   3E01           00245 Test4_label     addlw   01h                     ;Пауза для выравнивания путей
                      00246                 jnz             Test4_label
0073   1D03               M                 btfss           STATUS,Z                                        ; если не 0
0074   2872               M                 goto            Test4_label
0075   3000           00247                                 movlw           0
                      00248 
0076   3075           00249 Testend_label   movlw   075h
0077   3E01           00250                                 addlw   01h                     ;Ожидание окончания отклика DS18B20
                      00251                 jnz     Testend_label+1
0078   1D03               M                 btfss           STATUS,Z                                        ; если не 0
0079   2877               M                 goto            Testend_label+1
                      00252 
007A   3004           00253                                 movlw   04h                                     ;Если отклик DS18B20 пра
                            вильный, то TEMP1 = 4
007B   063C           00254                                 xorwf   TEMP1,W
007C   1903           00255                                 btfsc   STATUS,Z                ;TEMP1 = 4 ? 
007D   30FF           00256                                 movlw   0FFh                    ;Да  - установить признак присутствия (W
                            =0FFh)
007E   0008           00257 Stop_label      return                          ;Конец подпрограммы проверки
                      00258 
                      00259 ;--------------------------------------------------------------------------------------------------
                      00260                                 ;Подпрограмма ввода/вывода по шине 1-Wire (для приема задаем W=0FFh). Ис
                            пользуется TEMP1
007F                  00261 RW_1Wire         
007F   00BC           00262                                 movwf           TEMP1                                           ;Исходны
                            е данные в W
0080   3008           00263                                 movlw           08h                             ;8 бит
0081   00A9           00264                                 movwf           COUNTER
0082   138B           00265 RWLoop                          bcf             INTCON,GIE                      ;Запрет всех прерываний
0083   1205           00266                                 bcf             ds4                             ;0 --> 1-Wire
0084   1385           00267                                 bcf     ds7
0085   183C           00268                                 btfsc           TEMP1,0
0086   1605           00269                                 bsf     ds4                     ;Установить,если младший бит TEMP1 = 1
0087   183C           00270                                 btfsc           TEMP1,0
0088   1785           00271                                 bsf     ds7                                     ;Установить,если младший
                             бит TEMP1 = 1
0089   0CBC           00272                                 rrf             TEMP1,F                         ;Подготовить следующий б
                            ит
008A   30FD           00273                                 movlw   0FDh                                    ;Пауза ~12 мкс
008B   3E01           00274 RW_1label       addlw   01h
                      00275                                 jnz     RW_1label
008C   1D03               M                 btfss           STATUS,Z                                        ; если не 0
008D   288B               M                 goto            RW_1label
                      00276 
008E   13BC           00277                                 bcf     TEMP1,7                 ;Принимаем в тот же TEMP1
                      00278 ;//////////////
008F   1843           00279                                 btfsc           DS4_7,0                                         ;флаг вы
                            бора датчика =0 то ds4
0090   2894           00280                                 goto            DS7_2
                      00281 
0091   1A05           00282                                 btfsc   ds4
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0092   2895           00283                                 goto            bsfTEMP
                      00284 
0093   2896           00285                                 goto            movlw220
0094                  00286 DS7_2
0094   1B85           00287                                 btfsc   ds7
0095                  00288 bsfTEMP
0095   17BC           00289                                 bsf     TEMP1,7
0096                  00290 movlw220
0096   30DC           00291                                 movlw   D'220'                  ;Время на освобождение линии ведомым
0097   3E01           00292 RW_2label       addlw   01h
                      00293                                 jnz     RW_2label
0098   1D03               M                 btfss           STATUS,Z                                        ; если не 0
0099   2897               M                 goto            RW_2label
                      00294 
009A   1605           00295                                 bsf     ds4                     ;Отпускаем шину
009B   1785           00296                                 bsf     ds7
009C   178B           00297                                 bsf     INTCON,GIE              ;Разрешить прерывания
009D   0BA9           00298                                 decfsz  COUNTER,F                               ;8 бит обработаны?
009E   2882           00299                                 goto    RWLoop                  ;Еще нет - переход
                      00300 
009F   083C           00301                                 movf    TEMP1,W                 ;Принятый байт в W
00A0   0008           00302                                 return                                                          ;Конец п
                            одпрограммы ввода/вывода по шине 1-Wire
                      00303 ;--------------------------------------------------------------------------------------------------
                      00304                                 ;Подпрограмма обновления CRC. Параметр в W. Используются ячейки TEMP1, T
                            EMP2
                      00305 
00A1   0064           00306 NewCRC                          clrwdt
00A2   00BD           00307                                 movwf           TEMP2                           ;Сохранить W
00A3   3008           00308                                 movlw   08h
00A4   00A9           00309                                 movwf   COUNTER                 ;8 --> COUNTER
00A5   083D           00310                                 movf    TEMP2,W                 ;Восстановить значение W
00A6   0627           00311 CRC_label       xorwf   CRCPIC,W                ;Исключ.ИЛИ CRCPIC и W, результат в W
00A7   00BC           00312                                 movwf   TEMP1                   ;Скопировать результат в TEMP1
00A8   0C3C           00313                                 rrf     TEMP1,W                 ;Сдвиг TEMP1 вправо на 1, результат в W,
                             младший бит в С
00A9   0827           00314                                 movf    CRCPIC,W                ;CRCPIC --> W (бит С не изменился)
00AA   1803           00315                                 btfsc   STATUS,0
00AB   3A18           00316                                 xorlw   018h                    ;Если С=0, то эту инструкцию не выполнят
                            ь
00AC   00BC           00317                                 movwf   TEMP1                   ;Результат в TEMP1
00AD   0C3C           00318                                 rrf     TEMP1,W                 ;Снова сдвиг, результат в W
00AE   00A7           00319                                 movwf   CRCPIC                  ;Сохранить результат в CRCPIC
00AF   1003           00320                                 bcf     STATUS,0                ;0 --> C
00B0   0CBD           00321                                 rrf     TEMP2,F                 ;Сдвиг TEMP2 вправо на 1
00B1   083D           00322                                 movf    TEMP2,W                 ;И скопировать полученное значение в W
00B2   0064           00323                                 clrwdt
00B3   0BA9           00324                                 decfsz  COUNTER,F
00B4   28A6           00325                                 goto    CRC_label
00B5   0008           00326                                 return                                                          ;Конец п
                            одпрограммы обновления CRC
                      00327 ;--------------------------------------------------------------------------------------------------
                      00328                                 ;Подпрограмма Выбор режима переходa AUTO или SAM с записью состояния в E
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            EROM
                      00329                                 ;или перех ds4 на ds7
00B6                  00330 Auto_Sam
00B6   3028           00331                                 movlw           AT_1                                            ;Сброс п
                            о нажатию кнопки 
00B7   00C4           00332                                 movwf           AT1                                             ;задержк
                            и на переход в SLEEP
00B8   300A           00333                                 movlw           .10                                             ;Загрузк
                            а таймера на длительность удержания
00B9   00C2           00334                                 movwf           TO_3                                            ;кнопкин
                            а, отображение кнопки
00BA                  00335 M_0
                      00336                                 mvi             FIGX000,B'01111111'             ;Отображаем "...#"
00BA   307F               M                 movlw   B'01111111'
00BB   00AA               M                 movwf   FIGX000
                      00337                                 mvi             FIGX000,B'01111111'             ; ".FADEGBC" порядок соо
                            тв. сегмент-бит
00BC   307F               M                 movlw   B'01111111'
00BD   00AA               M                 movwf   FIGX000
                      00338                                 mvi             FIGX000,B'01111111'
00BE   307F               M                 movlw   B'01111111'
00BF   00AA               M                 movwf   FIGX000
                      00339                                 mvi             FIG000X,B'01100010'
00C0   3062               M                 movlw   B'01100010'
00C1   00AD               M                 movwf   FIG000X
00C2   2041           00340                                 call            Pause                                           ;\таймер
                             длительности удержания кн.
00C3   0BC2           00341                                 decfsz          TO_3,F                                          ; \
00C4   28E2           00342                                 goto            M_1                                             ;на пров
                            ерку "кнопка отпущена" 
                      00343                                                                                                 ;При дли
                            т. удержании кн. переход AUTO<->SAM
00C5   3003           00344                                 movlw           .3                                              ;Загрузк
                            а множителя для Паузы 3 
00C6   00C2           00345                                 movwf           TO_3                                            ;для ото
                            бражения Label_Auto Sam
00C7   1CC3           00346                                 btfss           DS4_7,1                                         ;Флаг вы
                            бора =1 то AUTO, если =0 то SAM
00C8   28D3           00347                                 goto            Label_Auto
00C9                  00348 Label_Sam       
00C9   10C3           00349                                 bcf             DS4_7,1                                         ;флаг вы
                            бора режима SAM
                      00350                                 mvi             FIGX000,B'10000111'             ;Отображаем "CAnn"
00CA   3087               M                 movlw   B'10000111'
00CB   00AA               M                 movwf   FIGX000
                      00351                                 mvi             FIG0X00,B'10010000'             ; ".FADEGBC" порядок соо
                            тв. сегмент-бит
00CC   3090               M                 movlw   B'10010000'
00CD   00AB               M                 movwf   FIG0X00
                      00352                                 mvi             FIG00X0,B'11110010'
00CE   30F2               M                 movlw   B'11110010'
00CF   00AC               M                 movwf   FIG00X0
                      00353                                 mvi             FIG000X,B'11111010'
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00D0   30FA               M                 movlw   B'11111010'
00D1   00AD               M                 movwf   FIG000X
00D2   28DC           00354                                 goto            PP_03
00D3                  00355 Label_Auto
00D3   14C3           00356                                 bsf             DS4_7,1                                         ;флаг вы
                            бора режима AUTO
                      00357                                 mvi             FIGX000,B'10010000'             ;Отображаем "Auto"
00D4   3090               M                 movlw   B'10010000'
00D5   00AA               M                 movwf   FIGX000
                      00358                                 mvi             FIG0X00,B'11100110'             ; ".FADEGBC" порядок соо
                            тв. сегмент-бит
00D6   30E6               M                 movlw   B'11100110'
00D7   00AB               M                 movwf   FIG0X00
                      00359                                 mvi             FIG00X0,B'10100011'
00D8   30A3               M                 movlw   B'10100011'
00D9   00AC               M                 movwf   FIG00X0
                      00360                                 mvi             FIG000X,B'11100010'
00DA   30E2               M                 movlw   B'11100010'
00DB   00AD               M                 movwf   FIG000X
                      00361 
00DC   30FA           00362 PP_03                           movlw           .250                                            ;Пауза 3
                             для отображения Label_Auto Sam
00DD   2041           00363                                 call            Pause
00DE   0BC2           00364                                 decfsz          TO_3,F
00DF   28DC           00365                                 goto            PP_03
                      00366 
00E0   2106           00367                                 call            WriteEEROM
00E1   0008           00368                                 return
                      00369 
00E2   183F           00370 M_1                             btfsc           FLAGS,But                       ;проверка кнопки =1 да
00E3   28BA           00371                                 goto            M_0
                      00372 
00E4   20EA           00373                                 call            SAMds4_7                        ;"кнопка отпущена" инвер
                            тировать бит DS4<->DS7
00E5   0008           00374                                 return
                      00375 
                      00376 ;--------------------------------------------------------------------------------------------------
                      00377                                 ;Подпрограмма таймера на переход с ds4 на ds7
                      00378 
00E6                  00379 AUTOds4_7
00E6   0BC0           00380                                 decfsz          TO_1,F                                          ;таймер 
                            на переход ds4 <-> ds7
00E7   0008           00381                                 return                                          
                      00382 
00E8   3002           00383                                 movlw           .2                                              ;загрузк
                            а множит для Пауза 2 для отображения Label_DS
00E9   00C0           00384                                 movwf           TO_1
00EA   1C43           00385 SAMds4_7        btfss           DS4_7,0                                         ;флаг выбора датчика =0 
                            то переход на ds7
00EB   28F6           00386                                 goto            Label_DS7
                      00387 
00EC   1043           00388 Label_DS4       bcf             DS4_7,0                                         ;флаг выбора ds4
                      00389                                 mvi             FIGX000,B'11111100'             ;Отображаем "Into"
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00ED   30FC               M                 movlw   B'11111100'
00EE   00AA               M                 movwf   FIGX000
                      00390                                 mvi             FIG0X00,B'11110010'             ; ".FADEGBC" порядок соо
                            тв. сегмент-бит
00EF   30F2               M                 movlw   B'11110010'
00F0   00AB               M                 movwf   FIG0X00
                      00391                                 mvi             FIG00X0,B'10100011'
00F1   30A3               M                 movlw   B'10100011'
00F2   00AC               M                 movwf   FIG00X0
                      00392                                 mvi             FIG000X,B'11100010'
00F3   30E2               M                 movlw   B'11100010'
00F4   00AD               M                 movwf   FIG000X
00F5   28FF           00393                                 goto            PP_02
                      00394 
00F6   1443           00395 Label_DS7       bsf             DS4_7,0                                         ;выбора ds7
                      00396                                 mvi             FIGX000,B'10000100'             ;Отображаем "Outs"
00F7   3084               M                 movlw   B'10000100'
00F8   00AA               M                 movwf   FIGX000
                      00397                                 mvi             FIG0X00,B'11100110'             ; ".FADEGBC" порядок соо
                            тв. сегмент-бит
00F9   30E6               M                 movlw   B'11100110'
00FA   00AB               M                 movwf   FIG0X00
                      00398                                 mvi             FIG00X0,B'10100011'
00FB   30A3               M                 movlw   B'10100011'
00FC   00AC               M                 movwf   FIG00X0
                      00399                                 mvi             FIG000X,B'10001010'
00FD   308A               M                 movlw   B'10001010'
00FE   00AD               M                 movwf   FIG000X
00FF   3050           00400 PP_02                           movlw           .80                                             ;Пауза 2
                             для отображения Label_DS
0100   2041           00401                                 call            Pause
0101   0BC0           00402                                 decfsz          TO_1,F
0102   28FF           00403                                 goto            PP_02
                      00404 
0103   3008           00405                                 movlw           .8                                              ;загрузк
                            а таймера на 
0104   00C0           00406                                 movwf           TO_1                                            ;последу
                            ющие переходы DS 4<->7 Пауза 1
0105   0008           00407                                 return
                      00408 
                      00409 ;=================================;Подпрограмма записи в EEROM
0106                  00410 WriteEEROM
0106   138B           00411                                 BCF             INTCON,         GIE                             ;Запреще
                            ние всех прерываний
0107   0843           00412                                 movf            DS4_7,w
0108   1683           00413                                 bsf             STATUS,RP0                      ;Банк 1
0109   009A           00414                                 MOVWF           EEDATA
010A   019B           00415                                 clrf            EEADR 
010B   151C           00416                                 BSF             EECON1,WREN                     ;Разрешение записи в EER
                            OM
010C   3055           00417                                 MOVLW           0x55                                            ;Даём на
                            бор команд для записи
010D   009D           00418                                 MOVWF           EECON2
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

010E   30AA           00419                                 MOVLW           0xAA
010F   009D           00420                                 MOVWF           EECON2
0110   149C           00421                                 BSF             EECON1,WR
0111   0000           00422 Zhdem                           NOP                                             ;Ожидание заверешения за
                            писи
0112   189C           00423                                 BTFSC           EECON1,WR
0113   2911           00424                                 GOTO            Zhdem
0114   111C           00425                                 BCF             EECON1,WREN                     ;Запрещение записи EEROM
0115   1283           00426                                 bcf             STATUS,RP0                      ;Банк 0
0116   178B           00427                                 BSF             INTCON,GIE                      ;Разреш всех прерыв
0117   0008           00428                                 return
                      00429 ;=================================
                      00430 
                      00431 ;====================;Подпрограмма чтения из EEPROM
0118                  00432 ReadEEROM
0118   1683           00433                                 bsf             STATUS,RP0                      ;Банк 1
0119   019B           00434                                 clrf            EEADR
011A   141C           00435                                 BSF             EECON1,RD                       ;Команда на чтение EEROM
011B   081A           00436                                 MOVF            EEDATA,w
011C   1283           00437                                 bcf             STATUS,RP0                      ;Банк 0
011D   00C3           00438                                 movwf           DS4_7
011E   0008           00439                                 return
                      00440 ;===================
                      00441 ;--------------------------------------------------------------------------------------------------
                      00442 ;__________________________________________________________________________________________________
                      00443 ;
                      00444 ;                --- НАЧАЛО ОСНОВНОЙ ПРОГРАММЫ ---
                      00445 ;__________________________________________________________________________________________________
011F                  00446 Start
011F   3002           00447                                 movlw           .2                                              ;Загрузк
                            а таймера на 
0120   00C0           00448                                 movwf           TO_1                                            ;первичн
                            ый переход DS 4<->7 Пауза 1
0121   00C1           00449                                 movwf           TO_2                                            ;Загрузк
                            а таймера на мояк индикацию выбронного DS
0122   14BF           00450                                 bsf             FLAGS,1
0123   2118           00451                                 call            ReadEEROM
0124                  00452 Begin
0124   3007           00453                                 movlw           7
0125   009F           00454                                 movwf           CMCON                                           ;Отключа
                            ем компараторы
0126   0885           00455                                 movf            PORTA,F                                         ;Приводи
                            м в соответствие
0127   0886           00456                                 movf            PORTB,F                                         ;защелки
                             портов
0128   018B           00457                                 clrf            INTCON
                      00458                                 mvi             PORTA,B'10010000'               ;Гасим все
0129   3090               M                 movlw   B'10010000'
012A   0085               M                 movwf   PORTA
                      00459                                 mvi             PORTB,B'00000000'               ;светодиоды
012B   3000               M                 movlw   B'00000000'
012C   0086               M                 movwf   PORTB
012D   0181           00460                                 clrf            TMR0
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

012E   1683           00461                                 bsf             STATUS,RP0                      ;Обращение к банку 1 для
                             доступа к TRIS и OPTION_REG
012F   158E           00462                                 bsf             PCON,OSCF                       ;=1 частота -4Мгц, =0  -
                            32кгц
                      00463                                 mvi             TRISA,B'00100000'               ;Устанавливаем выводы по
                            рта А как 'OOOOOOOO' (I-in, O-out)
0130   3020               M                 movlw   B'00100000'
0131   0085               M                 movwf   TRISA
0132   0186           00464                                 clrf            TRISB                                           ;Устанав
                            ливаем выводы порта B как 'OOOOOOOO'
                      00465                                 mvi             OPTION_REG,B'11000111'          ;Подключаем сначала TMR0
                             через делитель=256 к OSC
0133   30C7               M                 movlw   B'11000111'
0134   0081               M                 movwf   OPTION_REG
                      00466                                 mvi             OPTION_REG,B'11001101'          ;Переключаем предделител
                            ь 32 к WDT, TMR0 - таймер
0135   30CD               M                 movlw   B'11001101'
0136   0081               M                 movwf   OPTION_REG
0137   1283           00467                                 bcf             STATUS,RP0                      ;Обращение к банку 0
                      00468                                 mvi             ADDRESS,FIGX000                 ;Заносим в ADDRESS адрес
                             ячейки с начальной цифрой
0138   302A               M                 movlw   FIGX000
0139   00A3               M                 movwf   ADDRESS
                      00469                                 mvi             SELECTOR,B'00001000'            ;Готовимся к выводу нача
                            льной цифры ****
013A   3008               M                 movlw   B'00001000'
013B   00A4               M                 movwf   SELECTOR
                      00470                                 mvi             FIGX000,B'11111111'             ;Отображаем "_.OFF"
013C   30FF               M                 movlw   B'11111111'
013D   00AA               M                 movwf   FIGX000
                      00471                                 mvi             FIG0X00,B'11100010'             ;".FADEGBC" порядок соот
                            в. сегмент-бит
013E   30E2               M                 movlw   B'11100010'
013F   00AB               M                 movwf   FIG0X00
                      00472                                 mvi             FIG00X0,B'10010011'             ;F
0140   3093               M                 movlw   B'10010011'
0141   00AC               M                 movwf   FIG00X0
                      00473                                 mvi             FIG000X,B'10010011'             ;F
0142   3093               M                 movlw   B'10010011'
0143   00AD               M                 movwf   FIG000X
                      00474                                 mvi             INTCON,B'10100000'
0144   30A0               M                 movlw   B'10100000'
0145   008B               M                 movwf   INTCON
0146   30F0           00475                                 movlw           .240                                            
0147   2041           00476                                 call            Pause
0148   1CBF           00477                                 btfss           FLAGS,1                                         ;Обход п
                            ри вкл. питания и по выходу из SLEEP
0149   20EA           00478                                 call            SAMds4_7                        ;отсутствие одного выбир
                            аем другой датчик
014A   01BF           00479                                 clrf            FLAGS
014B   0064           00480                                 clrwdt
                      00481 
                      00482 ;                                                                               
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00483 ;               |- A -|                                                                                 
                                    
                      00484 ;               F     B                                                                                 
                                                    
                      00485 ;               |- G -|          .FADEGBC порядок соотв. сегмент-бит            
                      00486 ;               E     C          ||||||||                                                               
                                    
                      00487 ;               |- D -|  76543210                                                                       
                                                    
                      00488 ;
                      00489                                                                                                         
                                                                    
                      00490 ;------------------------------------------------
014C   0064           00491 Online_label    clrwdt                                           ;Работа с термометром DS18B20
                      00492 
                      00493 ;--------------------------------;Таймер на переход в SLEEP
014D                  00494 ATO
014D   1E85           00495                                 btfss           SLS                                             ;=1 При 
                            питании от сети обход SLEEP             
014E   0BC4           00496                                 decfsz          AT1,F
014F   2961           00497                                 goto            BTC
                      00498 
0150   138B           00499                                 bcf             INTCON,GIE                      ;Глобальное запр прерыва
                            ний
0151   3028           00500                                 movlw           AT_1                                            ;Задержк
                            а на SLEEP
0152   00C4           00501                                 movwf           AT1
                      00502                                 mvi             PORTA,B'10010000'               ;Гасим всё, Подпираем ds
                            4 и ds7
0153   3090               M                 movlw   B'10010000'
0154   0085               M                 movwf   PORTA
                      00503                                 mvi             PORTB,B'00000000'
0155   3000               M                 movlw   B'00000000'
0156   0086               M                 movwf   PORTB
0157   1683           00504                                 bsf             STATUS,RP0                      ;Обращение к банку 1
0158   1405           00505                                 bsf             TRISA,0                                         ;Устанав
                            ливаем выводы порта (I-in, O-out)
0159   1283           00506                                 bcf             STATUS,RP0                      ;Обращение к банку 0
015A   1005           00507                                 bcf             PORTA,0                                         ;
015B   108B           00508                                 bcf             INTCON,INTF                     ;Сброс флага
015C   160B           00509                                 bsf             INTCON,INTE                     ;Разреш прерывания INT
015D   0063           00510 SLEEP
015E   120B           00511                                 bcf             INTCON,INTE
015F   108B           00512                                 bcf             INTCON,INTF
0160   291F           00513                                 goto            Start
                      00514 
0161                  00515 BTC
0161   183F           00516                                 btfsc           FLAGS,But                       ;проверка кнопкифдрюкен 
                            =1 да
0162   20B6           00517                                 call            Auto_Sam                        ;Выбор режима переходa с
                             ds4 на ds7 AUTO или SAM
0163   18C3           00518                                 btfsc           DS4_7,1                                         ;флаг вы
                            бора =1 то AUTO, если =0 то SAM
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0164   20E6           00519                                 call            AUTOds4_7                       ;Подпрограмма AUTO перех
                            одa с ds4 на ds7
0165   0181           00520                                 clrf            TMR0
0166   204E           00521                                 call            TestDS                                          ;Сброс и
                             проверка термометра
0167   3AFF           00522                                 xorlw   0FFh
                      00523                                 jnz     Begin                                   ;Ошибка - переход на нач
                            ало программы
0168   1D03               M                 btfss           STATUS,Z                                        ; если не 0
0169   2924               M                 goto            Begin
016A   30CC           00524                                 movlw   0CCh                                    ;Команда "Skip ROM"
016B   207F           00525                                 call    RW_1Wire
016C   3044           00526                                 movlw   044h                                     ;Команда "Convert T"
016D   207F           00527                                 call    RW_1Wire
016E   30FF           00528                                 movlw   0FFh                                    ;Идет процесс преобразов
                            ания
016F   2041           00529                                 call    Pause
0170   30FF           00530                                 movlw   0FFh
0171   2041           00531                                 call    Pause
0172   30FF           00532                                 movlw   0FFh
0173   2041           00533                                 call    Pause
                      00534                                 mvi     TRY,08h                 ;8 попыток чтения
0174   3008               M                 movlw   08h
0175   00A8               M                 movwf   TRY
                      00535 
0176   0064           00536 Newtry_label    clrwdt                                          ;Начинаем чтение данных из DS18B20
0177   0181           00537                                 clrf    TMR0
0178   204E           00538                                 call    TestDS                                  ;Сброс и проверка термом
                            етра
0179   3AFF           00539                                 xorlw   0FFh
                      00540                                 jnz     Begin                                   ;Ошибка - переход на нач
                            ало программы
017A   1D03               M                 btfss           STATUS,Z                                        ; если не 0
017B   2924               M                 goto            Begin
                      00541 
017C   30CC           00542                                 movlw   0CCh                                    ;Команда "Skip ROM"
017D   207F           00543                                 call    RW_1Wire
017E   30BE           00544                                 movlw   0BEh                                    ;Команда "Read Scratchpa
                            d"
017F   207F           00545                                 call    RW_1Wire
0180   01A7           00546                                 clrf    CRCPIC
0181   30FF           00547                                 movlw   0FFh
0182   207F           00548                                 call    RW_1Wire
0183   00A6           00549                                 movwf   TL                      ;Младший байт температуры
0184   20A1           00550                                 call    NewCRC
0185   30FF           00551                                 movlw   0FFh
0186   207F           00552                                 call    RW_1Wire
0187   00A5           00553                                 movwf   TH                      ;Старший байт температуры
0188   20A1           00554                                 call    NewCRC
0189   30FF           00555                                 movlw   0FFh                    ;Шесть ненужных байт
018A   207F           00556                                 call    RW_1Wire
018B   20A1           00557                                 call    NewCRC
018C   30FF           00558                                 movlw   0FFh
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

018D   207F           00559                                 call    RW_1Wire
018E   20A1           00560                                 call    NewCRC
018F   30FF           00561                                 movlw   0FFh
0190   207F           00562                                 call    RW_1Wire
0191   20A1           00563                                 call    NewCRC
0192   30FF           00564                                 movlw   0FFh
0193   207F           00565                                 call    RW_1Wire
0194   20A1           00566                                 call    NewCRC
0195   30FF           00567                                 movlw   0FFh
0196   207F           00568                                 call    RW_1Wire
0197   20A1           00569                                 call    NewCRC
0198   30FF           00570                                 movlw   0FFh
0199   207F           00571                                 call    RW_1Wire
019A   20A1           00572                                 call    NewCRC
019B   30FF           00573                                 movlw   0FFh
019C   207F           00574                                 call    RW_1Wire
019D   0627           00575                                 xorwf   CRCPIC,W                ;Проверка совпадения CRC
                      00576                                 jz      OKCRC_label             ;Совпадение - переход
019E   1903               M                 btfsc           STATUS,Z                                        ; если 0
019F   29A3               M                 goto            OKCRC_label
                      00577 
01A0   0BA8           00578                                 decfsz          TRY,F
01A1   2976           00579                                 goto            Newtry_label                    ;Несовпадение - следующа
                            я попытка
                      00580 
01A2   2924           00581                                 goto    Begin                   ;Попытки исчерпаны
                      00582 
01A3   0064           00583 OKCRC_label     clrwdt
01A4   0CA5           00584                                 rrf             TH,F
01A5   0CA6           00585                                 rrf             TL,F
01A6   0CA5           00586                                 rrf             TH,F
01A7   0CA6           00587                                 rrf             TL,F
01A8   0CA5           00588                                 rrf             TH,F
01A9   0CA6           00589                                 rrf             TL,F                                            ; 64 | 3
                            2 | 16 | 8 || 4 | 2 | 1 | 0.5
01AA   30FF           00590                                 movlw           0FFh
01AB   00AA           00591                                 movwf           FIGX000                                         ;Гасим в
                            се цифры
01AC   00AB           00592                                 movwf           FIG0X00
01AD   00AC           00593                                 movwf           FIG00X0
01AE   00AD           00594                                 movwf           FIG000X
                      00595 
                      00596 ;------------------------------------------------
                      00597                                                                 ;Таймера на мояк label индикацию выбронн
                            ого DS
01AF   0BC1           00598                                 decfsz          TO_2,F
01B0   29B7           00599                                 goto            T100_Lb
01B1   1843           00600                                 btfsc           DS4_7,0                                         ;флаг вы
                            бора датчика =0 то ds4
01B2   12AA           00601                                 bcf             FIGX000,5                       ;зажеч верхн. сегмент
01B3   1C43           00602                                 btfss           DS4_7,0                                         ;флаг вы
                            бора датчика =0 то ds4
01B4   122A           00603                                 bcf             FIGX000,4                       ;зажеч нижн. сегмент
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01B5   3002           00604                                 movlw           .2                                              ;Загрузк
                            а таймера 
01B6   00C1           00605                                 movwf           TO_2
                      00606 ;---------------
01B7                  00607 T100_Lb
01B7   1C25           00608                                 btfss           TH,0                                            ;Темпера
                            тура отрицательная?
01B8   29BD           00609                                 goto            T100_label                      ;Нет - переход на провер
                            ку "больше/меньше 100"
                      00610                                                                                                 ;.FADEGB
                            C порядок соотв. сегмент-бит
01B9   112A           00611                                 bcf             FIGX000,2                       ;Да - отображаем "-" в с
                            таршем разряде
01BA   09A6           00612                                 comf            TL,F                                            ;Преобра
                            зование для правильного
01BB   0AA6           00613                                 incf            TL,F                                            ;отображ
                            ения отрицательных температур
01BC   29C6           00614                                 goto            Tshow_label                     ;Переход
                      00615 
                      00616 ;------------------------------------------------
                      00617 
01BD   1003           00618 T100_label       bcf            STATUS,C
01BE   0C26           00619                                  rrf            TL,W                                            ; W = <0
                            > | 64 | 32 | 16 || 8 | 4 | 2 | 1 
01BF   3E9C           00620                                  addlw          D'156'
                      00621                                  jnc            Tshow_label                     ;Если температура меньше
                             100 градусов - переход
01C0   1C03               M                 btfss           STATUS,C                                        ; если нет переноса
01C1   29C6               M                 goto            Tshow_label
                      00622 
01C2   30C8           00623                                  movlw          D'200'
01C3   02A6           00624                                  subwf          TL,F                                            ;Т не ме
                            нее 100 градусов - сотню вычитаем
                      00625                                  mvi            FIG0X00,B'11111100'             ;Отобразить "1" во второ
                            м разряде
01C4   30FC               M                 movlw   B'11111100'
01C5   00AB               M                 movwf   FIG0X00
                      00626 
                      00627 ;------------------------------------------------
                      00628 
01C6   1003           00629 Tshow_label      bcf            STATUS,C
01C7   0C26           00630                                  rrf            TL,W                                             ;W = <0
                            > | 64 | 32 | 16 || 8 | 4 | 2 | 1
01C8   00BD           00631                                  movwf          TEMP2
01C9   138B           00632 Divide                           bcf            INTCON,GIE
01CA   01AC           00633                                  clrf           FIG00X0
01CB   083D           00634                                  movf   TEMP2,W                                 ;Делим TEMP2 на 10 - пол
                            учаем десятки и единицы градусов
01CC   00BC           00635                                  movwf  TEMP1                   ;Заносим делимое TL в ТЕМР1 через W
01CD   1403           00636                                  bsf    STATUS,C                ;Установим признак переноса
01CE   083C           00637 Div_label        movf   TEMP1,W
01CF   00AD           00638                                  movwf  FIG000X                 ;Заносим значение из ТЕМР через W в оста
                            ток
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01D0   0AAC           00639                                  incf   FIG00X0,F               ;Каждый проход цикла увеличивает частное
                             на 1
01D1   300A           00640                                  movlw  D'10'                   ;10 -> W заносим делитель в W
01D2   02BC           00641                                  subwf  TEMP1,F                 ;(TEMP1 - W) -> TEMP1 и вычитаем его из 
                            делимого
                      00642                                  jc     Div_label               ;Если ТЕМР1 еще не стало <0, то вычитаем
                             снова и т.д.
01D3   1803               M                 btfsc           STATUS,C                                        ; если перенос
01D4   29CE               M                 goto            Div_label
                      00643 
01D5   03AC           00644                                  decf           FIG00X0,F                       
01D6   30FC           00645                                  movlw          B'11111100'
01D7   062B           00646                                  xorwf          FIG0X00,W                       ;Сотня отображается?
                      00647                                  jnz            High_label                      ;Нет - переход
01D8   1D03               M                 btfss           STATUS,Z                                        ; если не 0
01D9   29E1               M                 goto            High_label
                      00648 
01DA   082C           00649                                  movf           FIG00X0,W                       ;Да - отображаем десятки
                             и единицы градусов
01DB   2033           00650                                  call           DC7
01DC   00AC           00651                                  movwf          FIG00X0
01DD   082D           00652                                  movf           FIG000X,W                       ;.FADEGBC порядок соотв.
                             сегмент-бит
01DE   2033           00653                                  call           DC7
01DF   00AD           00654                                  movwf          FIG000X
01E0   29ED           00655                                  goto           Finish_label
                      00656 
                      00657 ;------------------------------------------------
01E1   082C           00658 High_label       movf           FIG00X0,W                       ;Отображаем десятки и единицы градусов
01E2   2033           00659                                  call           DC7
01E3   00AB           00660                                  movwf          FIG0X00
01E4   082D           00661                                  movf           FIG000X,W
01E5   2033           00662                                  call           DC7
01E6   00AC           00663                                  movwf          FIG00X0
01E7   13AC           00664                                  bcf            FIG00X0,7                       ;Отображаем точку
                      00665                                  mvi            FIG000X,B'10000100'             ;В младшем разряде по ум
                            олчанию "0"
01E8   3084               M                 movlw   B'10000100'
01E9   00AD               M                 movwf   FIG000X
01EA   308A           00666                                  movlw          B'10001010'                     ;"5"
01EB   1826           00667                                  btfsc          TL,0
01EC   00AD           00668                                  movwf          FIG000X                                         ;А если 
                            установлен бит "0,5 С" - то "5"
                      00669 
01ED   178B           00670 Finish_label     bsf            INTCON,GIE
01EE   294C           00671                                  goto   Online_label
                      00672 
                      00673                  end
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 19


SYMBOL TABLE
  LABEL                             VALUE 

ADDRESS                           00000023
ADEN                              00000003
AT1                               00000044
AT2                               00000045
ATO                               0000014D
AT_1                              00000028
AUTOds4_7                         000000E6
Auto_Sam                          000000B6
BRGH                              00000002
BTC                               00000161
BUT                               PORTA,0
BUTON                             00000027
Begin                             00000124
But                               00000000
C                                 00000000
C1INV                             00000004
C1OUT                             00000006
C2INV                             00000005
C2OUT                             00000007
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CIS                               00000003
CM0                               00000000
CM1                               00000001
CM2                               00000002
CMCON                             0000001F
CMIE                              00000006
CMIF                              00000006
COUNTER                           00000029
CRCPIC                            00000027
CRC_label                         000000A6
CREN                              00000004
CSRC                              00000007
DC                                00000001
DC7                               00000033
DS4_7                             00000043
DS7_0                             00000054
DS7_1                             0000006C
DS7_2                             00000094
Div_label                         000001CE
Divide                            000001C9
EEADR                             0000009B
EECON1                            0000009C
EECON2                            0000009D
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 20


SYMBOL TABLE
  LABEL                             VALUE 

EEDATA                            0000009A
EEIE                              00000007
EEIF                              00000007
End_int                           0000001F
F                                 00000001
FERR                              00000002
FIG000X                           0000002D
FIG00X0                           0000002C
FIG0X00                           0000002B
FIGX000                           0000002A
FLAGS                             0000003F
FSR                               00000004
FSR_copy                          00000022
Finish_label                      000001ED
GIE                               00000007
High_label                        000001E1
INDF                              00000000
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTF                              00000001
IRP                               00000007
Int_label                         0000001B
Interrupt                         00000004
Label_Auto                        000000D3
Label_DS4                         000000EC
Label_DS7                         000000F6
Label_Sam                         000000C9
M_0                               000000BA
M_1                               000000E2
NOT_BO                            00000000
NOT_BOD                           00000000
NOT_BOR                           00000000
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NewCRC                            000000A1
Newtry_label                      00000176
OERR                              00000001
OKCRC_label                       000001A3
OPTION_REG                        00000081
OSCF                              00000003
OUTA                              0000002E
Online_label                      0000014C
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PIE1                              0000008C
PIR1                              0000000C
PORTA                             00000005
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 21


SYMBOL TABLE
  LABEL                             VALUE 

PORTB                             00000006
PP_02                             000000FF
PP_03                             000000DC
PR2                               00000092
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
P_label                           00000047
Pause                             00000041
RBIE                              00000003
RBIF                              00000000
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RP0                               00000005
RP1                               00000006
RWLoop                            00000082
RW_1Wire                          0000007F
RW_1label                         0000008B
RW_2label                         00000097
RX9                               00000006
RX9D                              00000000
ReadEEROM                         00000118
Reset                             00000000
SAMds4_7                          000000EA
SELECTOR                          00000024
SLS                               PORTA,5
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
STATUS                            00000003
ST_copy                           00000021
SYNC                              00000004
Start                             0000011F
Stop_label                        0000007E
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T100_Lb                           000001B7
T100_label                        000001BD
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1OSCEN                           00000003
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TEMP1                             0000003C
TEMP2                             0000003D
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 22


SYMBOL TABLE
  LABEL                             VALUE 

TH                                00000025
TL                                00000026
TMR0                              00000001
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TO_1                              00000040
TO_2                              00000041
TO_3                              00000042
TRISA                             00000085
TRISB                             00000086
TRMT                              00000001
TRY                               00000028
TX9                               00000006
TX9D                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
Test1_label                       00000059
Test2_label                       0000005F
Test3_label                       00000064
Test4_label                       00000072
TestDS                            0000004E
Testend_label                     00000076
Tshow_label                       000001C6
V4_7                              flag,1
VR0                               00000000
VR1                               00000001
VR2                               00000002
VR3                               00000003
VRCON                             0000009F
VREN                              00000007
VROE                              00000006
VRR                               00000005
W                                 00000000
WR                                00000001
WREN                              00000002
WRERR                             00000003
W_copy                            00000020
WriteEEROM                        00000106
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 23


SYMBOL TABLE
  LABEL                             VALUE 

Z                                 00000002
Zhdem                             00000111
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_BOREN_OFF                        00003FBF
_BOREN_ON                         00003FFF
_CP_OFF                           00003FFF
_CP_ON                            00001FFF
_DATA_CP_OFF                      00003FFF
_DATA_CP_ON                       00003EFF
_ER_OSC_CLKOUT                    00003FFF
_ER_OSC_NOCLKOUT                  00003FFE
_EXTCLK_OSC                       00003FEF
_HS_OSC                           00003FEE
_INTOSC_OSC_CLKOUT                00003FFD
_INTOSC_OSC_NOCLKOUT              00003FFC
_INTRC_OSC_CLKOUT                 00003FFD
_INTRC_OSC_NOCLKOUT               00003FFC
_LP_OSC                           00003FEC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_MCLRE_OFF                        00003FDF
_MCLRE_ON                         00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC_CLKOUT                    00003FFF
_RC_OSC_NOCLKOUT                  00003FFE
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_XT_OSC                           00003FED
__16F628A                         00000001
autsam                            flag,0
bsfTEMP                           00000095
ds4                               PORTA,4
ds7                               PORTA,7
jc                                
jnc                               
jnz                               
jz                                
mov                               
movlw220                          00000096
mvi                               
sbros                             00000057
MPASM  5.03                     THERM628A.ASM   3-6-2015  20:15:48         PAGE 24


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)


0000 : XXX-XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXX- ----------------
2000 : -------X-------- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:   494
Program Memory Words Free:  1554


Errors   :     0
Warnings :     0 reported,     1 suppressed
Messages :     0 reported,    19 suppressed

